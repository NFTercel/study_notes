mongodb地理索引查询实践
======================

需求
------------------------------------------
给定一个用户的坐标，查询和他距离不超过 distance (km) 的人

查询方式
--------------------------------------------
### geoNear

- 参考： https://docs.mongodb.com/manual/reference/command/geoNear/

- 距离单位是 度数，距离从km转为degree的转换方式： d / 111.12

- 返回结果里会有距离

- 依赖地理索引，需要有2d或者2dsphere

- 返回结果会以距离排序（google发现该排序应该是不可更改的，只能先以距离排序）

- 返回结果默认最多100个，要更多的话，在geoNear之前加上 limit(1000000000), 自定义数量即可

- 查询方式示例

```ruby
user = User.find_by_nick_name "liukgg"

ur =  UserRelation.where(source_user_id: user.uuid).geo_near([user.longitude.to_f, user.latitude.to_f]).max_distance(10.0/111.12).first
ur["geo_near_distance"]
# => 9.999999988963282e-06
```

### geoWithin
- geoWithin 是最新用法，取代了 within

- 不依赖地理索引

- 返回结果没有距离信息

- 返回结果没有根据距离排序

### geoNear 和 geoWithin-$centerSphere的结果是不相同的
- 查询时，前者传入的距离是以 度数 为单位的, 而后者是以弧度为单位的

- 试验如下：

```ruby
  user = User.find_by_nick_name "liukgg" # => 坐标 [113.94755, 22.54023]
  results = []
  (1..110).each do |d|
     # 这里加上 limit(1000) 是因为geoNear默认是limit(100), 只返回100条数据
     near_count = UserRelation.where(source_user_id: user.uuid).limit(1000).
       geo_near([user.longitude.to_f, user.latitude.to_f]).max_distance(d / 111.12).
       count

     center_count = UserRelation.where(source_user_id: user.uuid).
       where(:location => {"$geoWithin" => {"$centerSphere" => [[user.longitude.to_f, user.latitude.to_f], d.to_f / 6371 ]}}).
       count

     results << [near_count, center_count]
   end

   results

# 实验结果： [[47, 47], [56, 59], [61, 61], [66, 68], [74, 76], [79, 80], [83, 85], [85, 88], [88, 91], [92, 93], [94, 97], [97, 99], [100, 100], [100, 101], [102, 103], [103, 108], [104, 111], [111, 112], [112, 113], [113, 114], [113, 114], [114, 114], [114, 115], [114, 115], [115, 115], [115, 115], [115, 115], [115, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 117], [117, 118], [118, 118], [118, 119], [118, 120], [119, 121], [119, 121], [121, 121], [121, 121], [121, 121], [121, 121], [121, 121], [121, 121], [121, 122], [121, 122], [121, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 124], [123, 125], [123, 126], [123, 127], [125, 128], [126, 128], [126, 129], [127, 129], [128, 129], [128, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 130], [129, 130], [129, 130], [129, 130], [130, 130]] 

# results.all?{|x| x[0] == x[1]} # => false
```

### geoNear 和 geoWithin-$center的结果是一致的
- 查询时，两者传入的距离都是以 度数 为单位的

- 试验如下：

```ruby
  user = User.find_by_nick_name "liukgg" # => 坐标 [113.94755, 22.54023]
  results = []
  (1..110).each do |d|
     # 这里加上 limit(1000) 是因为geoNear默认是limit(100), 只返回100条数据
     near_count = UserRelation.where(source_user_id: user.uuid).limit(1000).
       geo_near([user.longitude.to_f, user.latitude.to_f]).max_distance(d / 111.12).
       to_a.map{|x| x.calculate_distance user}.count

     center_count = UserRelation.where(source_user_id: user.uuid).
       where(:location => {"$geoWithin" => {"$center" => [[user.longitude.to_f, user.latitude.to_f], d.to_f / 111.12 ]}}).
       to_a.map{|x| x.calculate_distance user}.count

     results << [near_count, center_count]
   end

   results

# 结果： results如下
# [[47, 47], [56, 56], [61, 61], [66, 66], [74, 74], [79, 79], [83, 83], [85, 85], [88, 88], [92, 92], [93, 93], [96, 96], [100, 100], [100, 100], [102, 101], [103, 103], [104, 104], [111, 111], [112, 112], [113, 113], [113, 113], [114, 114], [114, 114], [114, 114], [115, 115], [114, 115], [115, 115], [115, 115], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [116, 116], [117, 117], [118, 118], [118, 118], [118, 118], [119, 119], [119, 119], [121, 121], [121, 121], [121, 121], [121, 121], [121, 121], [121, 121], [121, 121], [121, 121], [121, 121], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [122, 122], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [123, 123], [125, 125], [126, 126], [126, 126], [127, 127], [128, 128], [128, 128], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [129, 129], [130, 130]]

# results.all?{|x| x[0] == x[1]} # => true
```

参考资料
--------------------------------------------
### mongodb: geoWithin
https://docs.mongodb.com/v3.0/reference/operator/query/geoWithin/

### mongodb: $center
https://docs.mongodb.com/v3.0/reference/operator/query/center/#op._S_center

### mongodb: $centerSphere
https://docs.mongodb.com/v3.0/reference/operator/query/centerSphere/

### mongoid: geo_near
mongoid源码： mongoid/lib/mongoid/contextual/mongo.rb#geo_near
